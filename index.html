
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Fantasy Helper (Starter)</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 2rem; max-width: 720px; margin: auto; }
      button, a.btn { padding: 12px 16px; border-radius: 10px; border: 1px solid #ddd; text-decoration: none; display: inline-block; }
      .card { border: 1px solid #eee; border-radius: 12px; padding: 1rem; margin: 1rem 0; }
      .muted { color: #666; }
      .row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
      input { padding: 10px; border-radius: 8px; border: 1px solid #ddd; width: 100%; }
      code { background: #f7f7f7; padding: 2px 6px; border-radius: 6px; }
    </style>
  </head>
  <body>
    <h1>Fantasy Helper (Free Starter)</h1>
    <p class="muted">Paste your backend URL, connect Yahoo, then check connection.</p>

    <div class="card">
      <h2>Step 1 — Backend URL</h2>
      <p>Example: <code>https://your-backend.onrender.com</code></p>
      <input id="backendUrl" placeholder="https://your-backend.onrender.com">
      <div class="row" style="margin-top:0.75rem;">
        <button onclick="saveBackend()">Save Backend URL</button>
        <span id="saveMsg" class="muted"></span>
      </div>
    </div>

    <div class="card">
      <h2>Step 2 — Connect Yahoo</h2>
      <p>Click to start the Yahoo login and approve access.</p>
      <div class="row">
        <a class="btn" href="#" id="connectBtn" onclick="connectYahoo(event)">Connect Yahoo</a>
      </div>
    </div>

    <div class="card">
      <h2>Step 3 — Check Connection</h2>
      <p>Make sure the frontend can talk to the backend.</p>
      <div class="row">
        <button onclick="checkAuth()">Check Connection</button>
        <span class="muted" id="authMsg"></span>
      </div>
    </div>

    <div class="card">
      <h2>Step 4 — List Leagues (demo)</h2>
      <div class="row">
        <button onclick="listLeagues()">Load Leagues</button>
      </div>
      <pre id="leaguesBox" style="background:#f7f7f7;padding:10px;border-radius:8px;"></pre>
    </div>

    <!-- Step 5 — Choose a League -->
  <div class="card">
    <h2>Step 5 — Choose a League</h2>
    <p>Click to load your leagues, then pick one.</p>
    <div class="row">
      <button onclick="loadLeaguesDropdown()">Load My Leagues</button>
      <select id="leagueSel" style="min-width:280px;">
        <option value="">(none yet)</option>
      </select>
    </div>
  </div>

<!-- Step 6 — Work with the selected league -->
  <div class="card">
   <h2>Step 6 — Teams, Roster, Free Agents</h2>

    <div class="row" style="margin-bottom:8px;">
      <button onclick="loadTeams()">Load Teams</button>
      <select id="teamSel" style="min-width:280px;">
        <option value="">(no teams yet)</option>
      </select>
    </div>

    <div class="row" style="margin-bottom:8px;">
      <input id="weekInput" placeholder="Week (optional, e.g. 1)" style="max-width:160px;">
      <button onclick="loadRoster()">Load Team Roster</button>
    </div>

    <div class="row" style="margin-bottom:8px;">
      <input id="faCount" value="25" style="max-width:120px;">
      <button onclick="loadFreeAgents()">Load Free Agents</button>
    </div>

    <pre id="outBox" style="background:#f7f7f7;padding:10px;border-radius:8px;white-space:pre-wrap;"></pre>
  </div>


   <script>
  function getBackend() {
    return localStorage.getItem("backendUrl") || document.getElementById("backendUrl").value;
  }
  function saveBackend() {
    const url = document.getElementById("backendUrl").value.trim();
    if (!url) { alert("Please enter your backend URL"); return; }
    localStorage.setItem("backendUrl", url);
    document.getElementById("saveMsg").textContent = "Saved!";
  }
  function connectYahoo(e) {
    e.preventDefault();
    const b = getBackend();
    if (!b) { alert("Save your backend URL first."); return; }
    window.location.href = b + "/auth/yahoo/login";
  }
  async function checkAuth() {
    const b = getBackend();
    if (!b) { alert("Set backend URL first."); return; }
    try {
      const r = await fetch(b + "/auth/check", { credentials: "include" });
      const j = await r.json();
      document.getElementById("authMsg").textContent = JSON.stringify(j);
    } catch (e) {
      document.getElementById("authMsg").textContent = "Failed to reach backend: " + e;
    }
  }
  async function listLeagues() {
    const b = getBackend();
    if (!b) { alert("Set backend URL first."); return; }
    try {
      const r = await fetch(b + "/leagues", { credentials: "include" });
      const j = await r.json();
      document.getElementById("leaguesBox").textContent = JSON.stringify(j, null, 2);
    } catch (e) {
      document.getElementById("leaguesBox").textContent = "Error: " + e;
    }
  }

  // NEW: load leagues into the dropdown
  async function loadLeaguesDropdown() {
    const b = getBackend();
    if (!b) { alert("Set backend URL first."); return; }
    const sel = document.getElementById("leagueSel");
    sel.innerHTML = "<option>(loading...)</option>";
    try {
      const r = await fetch(b + "/leagues", { credentials: "include" });
      const j = await r.json();
      const leagues = (j && j.leagues) || [];
      sel.innerHTML = "";
      if (!leagues.length) {
        sel.innerHTML = "<option value=''>No leagues found</option>";
        return;
      }
      for (const L of leagues) {
        const opt = document.createElement("option");
        opt.value = L.league_key;
        opt.textContent = `${L.name} — ${L.league_key}`;
        sel.appendChild(opt);
      }
    } catch (e) {
      sel.innerHTML = "<option value=''>Error loading leagues</option>";
    }
  }

  // NEW: load teams for the selected league, fill team dropdown
  async function loadTeams() {
    const b = getBackend();
    const leagueKey = document.getElementById("leagueSel").value;
    const teamSel = document.getElementById("teamSel");
    const out = document.getElementById("outBox");
    if (!b) { alert("Set backend URL first."); return; }
    if (!leagueKey) { alert("Pick a league first in Step 5."); return; }
    teamSel.innerHTML = "<option>(loading...)</option>";
    out.textContent = "";
    try {
      const r = await fetch(`${b}/league/${encodeURIComponent(leagueKey)}/teams`, { credentials: "include" });
      const j = await r.json();
      out.textContent = JSON.stringify(j, null, 2);
      const teams = (j && j.teams) || [];
      teamSel.innerHTML = "";
      if (!teams.length) {
        teamSel.innerHTML = "<option value=''>No teams found</option>";
        return;
      }
      for (const T of teams) {
        const opt = document.createElement("option");
        opt.value = T.team_key;
        opt.textContent = `${T.name} — ${T.team_key}`;
        teamSel.appendChild(opt);
      }
    } catch (e) {
      teamSel.innerHTML = "<option value=''>Error</option>";
      out.textContent = "Error: " + e;
    }
  }

  // NEW: load roster for the selected team (optional week)
  async function loadRoster() {
    const b = getBackend();
    const teamKey = document.getElementById("teamSel").value;
    const week = (document.getElementById("weekInput").value || "").trim();
    const out = document.getElementById("outBox");
    if (!b) { alert("Set backend URL first."); return; }
    if (!teamKey) { alert("Load teams and pick a team first."); return; }
    const qs = week ? `?week=${encodeURIComponent(week)}` : "";
    try {
      const r = await fetch(`${b}/team/${encodeURIComponent(teamKey)}/roster${qs}`, { credentials: "include" });
      const j = await r.json();
      out.textContent = JSON.stringify(j, null, 2);
    } catch (e) {
      out.textContent = "Error: " + e;
    }
  }

  // NEW: load free agents for the selected league
  async function loadFreeAgents() {
    const b = getBackend();
    const leagueKey = document.getElementById("leagueSel").value;
    const count = (document.getElementById("faCount").value || "25").trim();
    const out = document.getElementById("outBox");
    if (!b) { alert("Set backend URL first."); return; }
    if (!leagueKey) { alert("Pick a league first in Step 5."); return; }
    try {
      const r = await fetch(`${b}/league/${encodeURIComponent(leagueKey)}/free_agents?count=${encodeURIComponent(count)}`, { credentials: "include" });
      const j = await r.json();
      out.textContent = JSON.stringify(j, null, 2);
    } catch (e) {
      out.textContent = "Error: " + e;
    }
  }

  document.getElementById("backendUrl").value = localStorage.getItem("backendUrl") || "";
</script>

  </body>
</html>
